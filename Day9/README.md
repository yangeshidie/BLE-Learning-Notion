# Day 9: 极致低功耗 (Low Power)

> **学习目标**：从“功能实现”迈向“能效优化”。学会通过关闭外设、优化广播参数和电源管理配置，将 nRF52832 的待机电流压榨到微安 (uA) 级别。

---

## 1. 硬件准备

| 组件               | 说明                                                       |
| :----------------- | :--------------------------------------------------------- |
| **MCU**      | nRF52832 (官方 DK 或 第三方核心板)                         |
| **测量工具** | 万用表 (需支持 uA/mA 档位) 或 Power Profiler Kit (PPK)     |
| **供电方式** | 纽扣电池 / 外部电源 (推荐)，或 USB 供电 (需注意调试器干扰) |
| **连接线**   | 杜邦线 (用于串联万用表)                                    |

---

## 2. 学习目标

BLE 最大的优势在于**低功耗**。一个优化得当的设备可以用一颗纽扣电池工作数月甚至数年。
本章节的核心任务是：

- **做减法**：关闭所有不必要的外设（UART, Log, RTT）。
- **优化时序**：拉长广播间隔，减少射频开启时间。
- **系统休眠**：确保 CPU 在空闲时进入 System ON (Idle) 模式，而不是忙等待。
- **克服硬件干扰**：理解板载 LED 和调试器对电流测量的毁灭性影响。

---

## 3. 核心概念解析

### 3.1 功耗的组成

在 BLE 应用中，功耗主要由两部分组成：

1. **底电流 (Floor Current)**: 设备休眠时的电流。主要由漏电流、RTC (实时时钟) 和 RAM 保持电流组成。理想情况下应 **< 3uA**。
2. **峰值电流 (Peak Current)**: CPU 运行或射频 (Radio) 发射/接收时的电流。nRF52832 发射时约为 5mA - 7mA。

**优化策略**：我们需要极力降低**底电流**，并减少**峰值电流**出现的频率。

### 3.2 隐形杀手：UART 与 HFCLK

这是新手最容易忽略的点。
只要开启了串口 (UART) 接收功能，芯片的 **高频时钟 (HFCLK)** 就必须一直运行，这会导致底电流高达 **500uA - 1mA**，无论你是否在发数据。
**解决办法**：在不需要通信时，必须彻底关闭 UART 外设（或在 Kconfig 中直接禁用）。

### 3.3 广播参数的权衡

广播间隔 (`Advertising Interval`) 决定了设备多久醒来喊一次“我在儿”。

* **100ms**: 连接快，费电。
* **1000ms**: 标准低功耗设置。
* **2000ms+**: 极致省电，但连接变慢。

---

## 4. 实现步骤详解

### 步骤 1: 建立基准 (Debug 版本)

在优化之前，先保证功能正常。使用带有 Log 的配置，确认广播参数生效。

**关键代码 (main.c)**:

```c
/* 定义 2000ms 的广播间隔 */
static struct bt_le_adv_param *adv_param = BT_LE_ADV_PARAM(
    BT_LE_ADV_OPT_CONNECTABLE, 
    3200, // Min: 3200 * 0.625ms = 2000ms
    3200, // Max: 3200 * 0.625ms = 2000ms
    NULL
);

/* 启动广播 */
err = bt_le_adv_start(adv_param, ad, ARRAY_SIZE(ad), sd, ARRAY_SIZE(sd));
```

### 步骤 2: 极致优化配置 (prj.conf)

这是 Day 9 的核心。我们需要创建一个 `low_power.conf` 或者修改 `prj.conf`，关掉所有“废话”。

```properties
# ==========================================
# 1. 基础功能
# ==========================================
CONFIG_BT=y
CONFIG_BT_PERIPHERAL=y
CONFIG_BT_DEVICE_NAME="MyBLE"

# ==========================================
# 2. 关闭耗电大户 (UART & Log)
# ==========================================
# 彻底禁用串口驱动，释放 HFCLK
CONFIG_SERIAL=n
CONFIG_UART_CONSOLE=n

# 禁用日志系统，防止 CPU 为了打印日志而唤醒
CONFIG_LOG=n
CONFIG_CONSOLE=n
CONFIG_PRINTK=n

# 禁用 RTT (Segger RTT 也会有微小消耗)
CONFIG_USE_SEGGER_RTT=n

# ==========================================
# 3. 电源管理
# ==========================================
# 启用电源管理子系统
CONFIG_PM=y
CONFIG_PM_DEVICE=y
```

### 步骤 3: 代码逻辑优化 (main.c)

在 `main` 函数的末尾，绝不能使用 `while(1){}` 空转，也不能用 `k_busy_wait`。

```c
int main(void)
{
    // ... 初始化和广播启动代码 ...

    // 正确的休眠姿势：
    // K_FOREVER 让当前线程永久挂起。
    // Zephyr 的 Idle Thread 会接管 CPU，并自动执行 WFE (Wait For Event) 指令进入休眠。
    for (;;) {
        k_sleep(K_FOREVER); 
    }
    return 0;
}
```

---

## 5. 测量避坑指南 (硬件篇)

这是最容易让人怀疑人生的一步。代码写对了，为什么电流还是很大？

### 坑 1: 板载电源指示灯 (Power LED)

* **现象**: 万用表读数死活在 2mA 以上。
* **原因**: 大多数第三方核心板，电源指示灯直接并联在 VCC 上。一个 LED 亮起就需要 **2mA - 10mA**。
* **对比**: nRF52 休眠只需要 **2uA**。LED 的耗电是芯片的 **1000倍**。
* **对策**:
  1. **官方 DK 板**: 使用专门的电流测量排针 (P22)，它位于 LED 电路之后。
  2. **第三方板**: 必须**破坏性拆除** LED 旁边的电阻，或者接受无法测量 uA 级电流的事实（只能通过逻辑验证）。

### 坑 2: 调试器连接 (J-Link)

* **现象**: 电流在几百 uA 波动。
* **原因**: 如果 USB 线插着，或者 J-Link 处于 Debug Session 中，芯片内的调试模块 (DAP) 会处于激活状态，消耗额外电流。
* **对策**: 烧录完毕后，**拔掉 USB 线**，使用电池供电，并按一下复位键。

### 坑 3: 悬空引脚 (Floating Pins)

* **现象**: 电流不稳定，偶尔漂移。
* **原因**:由于 CMOS 工艺特性，输入引脚如果悬空（既不接高也不接低），可能会在中间电平震荡，导致漏电。
* **对策**: 在 DeviceTree 中确保未使用的引脚配置为断开连接，或在初始化时将其设为模拟输入模式。

---

## 6. 验收标准

### 逻辑验收 (如果不方便测电流)

- [X] **手机可搜到**: nRF Connect 能扫描到 "MyBLE"。
- [X] **广播变慢**: 手机上 RSSI (信号强度) 的刷新频率明显变慢 (约 2秒一次)。
- [X] **静默运行**: 没有任何串口或 RTT 日志输出。

### 数据验收 (如果有条件测电流)

- [X] **底电流 (Idle)**: 在两次广播之间，万用表读数应 **< 10uA** (理想值 2-3uA)。
- [X] **平均电流**: 除去 LED 损耗，2秒间隔下的平均电流应在 **10uA - 20uA** 之间。

---

## 7. 学习总结

Day 9 是从软件工程师向嵌入式系统工程师跨越的关键一步。

1. **每一微安都很贵**: 在电池供电的设备上，任何一行多余的 `printk` 或一个没关的 `UART` 都是不可接受的奢侈。
2. **硬件决定上限**: 软件优化得再好，一个设计不当的硬件电路（如常亮的 LED、分压电阻）会让所有努力白费。
3. **基准测试**: 遇到功耗问题，先回退到最简单的 Beacon 代码，测出板子的“本底噪声”，再逐个模块排查。

---

**Next Step**: Day 10 -空中升级 (FOTA/DFU)。
